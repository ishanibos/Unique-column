<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masterdata Hierarchy Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .drop-zone {
            transition: all 0.2s ease;
            border: 2px dashed #cbd5e1;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.01);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-6xl mx-auto py-10 px-6">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-black text-slate-800 tracking-tight mb-2 uppercase">Masterdata Logic Processor</h1>
            <p class="text-slate-500 text-lg">Generate UniqueKeys and Numeric IDs based on your category hierarchy.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Sidebar: Controls -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">1. Upload File</h3>
                    <div id="dropZone" class="drop-zone rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer bg-slate-50 hover:bg-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-slate-700 font-semibold text-center text-sm">Drop your Excel here</p>
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                    </div>
                    <p id="fileNameDisplay" class="mt-3 text-xs text-blue-600 font-medium hidden truncate"></p>
                </div>

                <div id="configCard" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 opacity-50 pointer-events-none transition-opacity">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">2. Hierarchy Selection</h3>
                    <p class="text-xs text-slate-500 mb-4">Choose columns to build the UniqueKey (usually Category > Sub > Minor):</p>
                    <div id="columnCheckboxes" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                        <!-- Filled by JS -->
                    </div>
                    <button id="processBtn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-100">
                        Generate Keys & IDs
                    </button>
                </div>
            </div>

            <!-- Right: Results & Preview -->
            <div class="lg:col-span-2 space-y-6">
                <div id="resultsCard" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hidden animate-in fade-in slide-in-from-bottom-4">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Processing Complete</h2>
                            <p id="statsDisplay" class="text-sm text-slate-500">Ready for export.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="dlMappingBtn" class="flex-1 md:flex-none bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold px-4 py-2 rounded-lg flex items-center justify-center">
                                Export Mapping (Sheet 2)
                            </button>
                            <button id="dlFullBtn" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold px-4 py-2 rounded-lg flex items-center justify-center">
                                Export Full (Sheet 1)
                            </button>
                        </div>
                    </div>

                    <div class="border border-slate-100 rounded-xl overflow-hidden">
                        <div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-500 border-b">PREVIEW: UNIQUE MAPPING TABLE</div>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-slate-100 text-slate-600 border-b">
                                    <tr>
                                        <th class="px-4 py-2">UniqueKey</th>
                                        <th class="px-4 py-2">NumericID</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody" class="divide-y divide-slate-100">
                                    <!-- Filled by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="instructions" class="bg-blue-50 border border-blue-100 rounded-2xl p-8 flex items-start space-x-4">
                    <div class="bg-blue-100 p-2 rounded-lg text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-blue-800 mb-1">How it works</h4>
                        <ul class="text-sm text-blue-700 space-y-1 list-disc ml-4">
                            <li>Upload your item list (Sheet 1).</li>
                            <li>Select the hierarchy columns.</li>
                            <li>The tool creates a <b>UniqueKey</b> (Text|Text|Text).</li>
                            <li>It creates a <b>Numeric ID</b> for every unique combination.</li>
                            <li>Download the <b>Mapping</b> (your Sheet 2) or the <b>Enriched List</b> (your Sheet 1).</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let headers = [];
        let uniqueMap = [];
        let fullSortedData = [];

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const configCard = document.getElementById('configCard');
        const colContainer = document.getElementById('columnCheckboxes');
        const processBtn = document.getElementById('processBtn');
        const resultsCard = document.getElementById('resultsCard');
        const previewBody = document.getElementById('previewBody');
        const statsDisplay = document.getElementById('statsDisplay');

        // Drag/Drop Setup
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            fileNameDisplay.innerText = "Selected: " + file.name;
            fileNameDisplay.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(ws, { defval: "" });
                
                if (rawData.length > 0) {
                    headers = Object.keys(rawData[0]);
                    setupHierarchySelection();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function setupHierarchySelection() {
            colContainer.innerHTML = '';
            headers.forEach(h => {
                const div = document.createElement('div');
                div.className = "flex items-center p-2 rounded hover:bg-slate-50 border border-transparent hover:border-slate-200 cursor-pointer transition";
                
                const isDefault = ["Category", "SubCategory", "MinorCategory"].includes(h);
                
                div.innerHTML = `
                    <input type="checkbox" id="chk_${h}" value="${h}" ${isDefault ? 'checked' : ''} class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                    <label for="chk_${h}" class="ml-3 text-sm font-medium text-slate-700 cursor-pointer flex-grow">${h}</label>
                `;
                colContainer.appendChild(div);
            });
            configCard.classList.remove('opacity-50', 'pointer-events-none');
        }

        processBtn.addEventListener('click', () => {
            const selectedCols = Array.from(document.querySelectorAll('#columnCheckboxes input:checked')).map(i => i.value);
            
            if (selectedCols.length === 0) {
                alert("Please select at least one column for the hierarchy.");
                return;
            }

            // 1. Generate Unique Keys and Mapping
            const tempMap = new Map();
            let idCounter = 1;

            fullSortedData = rawData.map(row => {
                // Build the pipe-separated key
                const key = selectedCols.map(col => String(row[col] || "").trim()).join('|');
                
                if (!tempMap.has(key)) {
                    tempMap.set(key, idCounter++);
                }

                // Inject key and ID into the record
                return {
                    ...row,
                    "UniqueKey": key,
                    "Numeric_UniqueKey": tempMap.get(key)
                };
            }).sort((a, b) => a.Numeric_UniqueKey - b.Numeric_UniqueKey);

            // 2. Prepare the mapping table (Sheet 2 style)
            uniqueMap = Array.from(tempMap.entries()).map(([key, id]) => ({
                "UniqueKey": key,
                "NumericUniqueValue": id
            }));

            renderPreview();
        });

        function renderPreview() {
            previewBody.innerHTML = '';
            uniqueMap.slice(0, 15).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2 font-mono text-[10px] text-slate-500">${item.UniqueKey}</td>
                    <td class="px-4 py-2 font-bold text-blue-600">${item.NumericUniqueValue}</td>
                `;
                previewBody.appendChild(tr);
            });

            if (uniqueMap.length > 15) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="2" class="px-4 py-2 text-center text-slate-400 italic">... and ${uniqueMap.length - 15} more combinations</td>`;
                previewBody.appendChild(tr);
            }

            statsDisplay.innerText = `Processed ${rawData.length} items into ${uniqueMap.length} unique category IDs.`;
            resultsCard.classList.remove('hidden');
            resultsCard.scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('dlMappingBtn').addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(uniqueMap);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Unique Mapping Table");
            XLSX.writeFile(wb, "Mapping_Table_Sheet2.xlsx");
        });

        document.getElementById('dlFullBtn').addEventListener('click', () => {
            const ws = XLSX.utils.json_to_sheet(fullSortedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Enriched Masterdata");
            XLSX.writeFile(wb, "Enriched_Masterdata_Sheet1.xlsx");
        });
    </script>
</body>
</html>